; =============================================================================
; PlatformIO Project Configuration File
; Advanced Walkie-Talkie Firmware
; מכשיר קשר מתקדם
; =============================================================================

[platformio]
default_envs = esp32-release
src_dir = src
include_dir = include
lib_dir = lib
data_dir = data
build_dir = .pio/build
boards_dir = boards

; =============================================================================
; Shared Settings
; =============================================================================

[common]
build_flags = 
    -DFIRMWARE_VERSION=\"1.0.0\"
    -DDEVICE_NAME=\"WT-PRO\"
    -I include
    -I include/hal
    -I include/core
    -I include/comm
    -Wall
    -Wextra
    -Wno-unused-parameter

lib_deps = 
    ; LoRa radio driver
    sandeepmistry/LoRa @ ^0.8.0
    ; OLED display
    adafruit/Adafruit SSD1306 @ ^2.5.7
    adafruit/Adafruit GFX Library @ ^1.11.5
    ; SD card
    arduino-libraries/SD @ ^1.2.4
    ; Audio codec (optional - for I2S)
    ; earlephilhower/ESP8266Audio @ ^1.9.7

monitor_speed = 115200
monitor_filters = esp32_exception_decoder

upload_speed = 921600

; =============================================================================
; ESP32 Development Environment (ESP-IDF)
; =============================================================================

[env:esp32]
platform = espressif32 @ ^6.4.0
board = esp32dev
framework = espidf
board_build.partitions = partitions_custom.csv

build_flags = 
    ${common.build_flags}
    -DESP32
    -DCONFIG_ESP32_DEFAULT_CPU_FREQ_240=1
    ; Enable USB CDC for firmware upload via USB
    -DARDUINO_USB_CDC_ON_BOOT=1
    ; Audio configuration
    -DAUDIO_SAMPLE_RATE=8000
    -DAUDIO_BITS=16

; ESP-IDF specific configuration
board_build.embed_files =
    data/splash.bin

; Upload settings
upload_protocol = esptool
upload_port = COM3
; Alternative upload ports:
; upload_port = /dev/ttyUSB0        ; Linux
; upload_port = /dev/cu.usbserial*  ; macOS

; Debug settings
debug_tool = esp-prog
debug_init_break = tbreak app_main

monitor_speed = ${common.monitor_speed}

; =============================================================================
; ESP32 Arduino Framework (Alternative)
; =============================================================================

[env:esp32-arduino]
platform = espressif32 @ ^6.4.0
board = esp32dev
framework = arduino
board_build.partitions = partitions_custom.csv

build_flags = 
    ${common.build_flags}
    -DESP32
    -DARDUINO_ARCH_ESP32
    -DCORE_DEBUG_LEVEL=3

lib_deps = ${common.lib_deps}

upload_protocol = esptool
upload_port = auto
upload_speed = ${common.upload_speed}

monitor_speed = ${common.monitor_speed}
monitor_filters = ${common.monitor_filters}

; =============================================================================
; ESP32-S3 with USB OTG (Recommended for USB Mass Storage)
; =============================================================================

[env:esp32s3]
platform = espressif32 @ ^6.4.0
board = esp32-s3-devkitc-1
framework = espidf
board_build.partitions = partitions_custom_s3.csv

build_flags = 
    ${common.build_flags}
    -DESP32S3
    -DCONFIG_TINYUSB_ENABLED=1
    -DCONFIG_TINYUSB_MSC_ENABLED=1
    ; USB OTG for Mass Storage
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1

; USB OTG upload (no UART needed)
upload_protocol = esp-builtin
; Fallback: upload_protocol = esptool

monitor_speed = ${common.monitor_speed}

; =============================================================================
; ESP32-C3 (Lower cost, RISC-V)
; =============================================================================

[env:esp32c3]
platform = espressif32 @ ^6.4.0
board = esp32-c3-devkitm-1
framework = espidf

build_flags = 
    ${common.build_flags}
    -DESP32C3
    -DARDUINO_USB_CDC_ON_BOOT=1

upload_protocol = esptool
monitor_speed = ${common.monitor_speed}

; =============================================================================
; Release Build (Optimized, no debug)
; =============================================================================

[env:esp32-release]
extends = env:esp32
build_type = release

build_flags = 
    ${env:esp32.build_flags}
    -Os
    -DNDEBUG
    -DRELEASE_BUILD
    -ffunction-sections
    -fdata-sections

build_unflags = 
    -Og
    -g

; Generate firmware binary for distribution
extra_scripts = 
    pre:scripts/version_bump.py
    post:scripts/copy_firmware.py

; =============================================================================
; Debug Build (Full debug, symbols)
; =============================================================================

[env:esp32-debug]
extends = env:esp32
build_type = debug

build_flags = 
    ${env:esp32.build_flags}
    -Og
    -g3
    -DDEBUG_BUILD
    -DCORE_DEBUG_LEVEL=5

debug_tool = esp-prog
debug_init_break = tbreak app_main
debug_speed = 5000

; =============================================================================
; OTA Update Environment
; =============================================================================

[env:esp32-ota]
extends = env:esp32-release

upload_protocol = espota
upload_port = walkie-talkie.local
; Alternative: upload_port = 192.168.1.100
upload_flags = 
    --port=3232
    --auth=walkie-ota-password

; =============================================================================
; Unit Testing
; =============================================================================

[env:native]
platform = native
build_flags = 
    -DNATIVE_BUILD
    -DSIMULATOR
    -std=c11
    -I include
    -I include/hal
    -I include/core
    -I include/comm

lib_deps = 
    throwtheswitch/Unity @ ^2.5.2

test_build_src = yes

; =============================================================================
; Custom Partition Tables
; =============================================================================
; Create these files in the project root:
;
; partitions_custom.csv:
; # Name,   Type, SubType, Offset,  Size, Flags
; nvs,      data, nvs,     0x9000,  0x5000,
; otadata,  data, ota,     0xe000,  0x2000,
; app0,     app,  ota_0,   0x10000, 0x1E0000,
; app1,     app,  ota_1,   0x1F0000,0x1E0000,
; spiffs,   data, spiffs,  0x3D0000,0x20000,
; recordings,data,fat,     0x3F0000,0x10000,
;
; partitions_custom_s3.csv:
; # For ESP32-S3 with more flash (8MB+)
; # Name,   Type, SubType, Offset,  Size, Flags
; nvs,      data, nvs,     0x9000,  0x5000,
; otadata,  data, ota,     0xe000,  0x2000,
; app0,     app,  ota_0,   0x10000, 0x300000,
; spiffs,   data, spiffs,  0x310000,0x100000,
; recordings,data,fat,     0x410000,0x3F0000,

